pkgname=hashicorp-vagrant
pkgver=%VERSION%
pkgrel=1
pkgdesc="Build and distribute virtualized development environments"
arch=('x86_64')
url="https://www.vagrantup.com"
license=('MIT')
_pkg_ver="%PKGVERSION%"
source=("vagrant.tar.gz::https://github.com/hashicorp/vagrant/archive/${_pkg_ver}.tar.gz"
        "installer.tar.gz::https://github.com/hashicorp/vagrant-installers/archive/master.tar.gz")
conflicts=('vagrant' 'vagrant-substrate')
options=('!emptydirs')
md5sums=('SKIP' 'SKIP')
depends=('libffi>=3.2.1' 'libxml2>=2.9.4' 'libxslt>=1.1.29'
         'libyaml' 'zlib>=1.2.11' 'xz>=5.2.3' 'readline>=6.3'
         'openssl>=1.0.2l' 'libssh2>=1.8.0' 'libarchive' 'curl>=7.54.0' 'ruby>=2.3.4'
         'rsync', 'base-devel')

makedepends=('ruby' 'go')

prepare() {
  mkdir -p "${srcdir}/opt/vagrant/embedded/etc"
  mkdir -p "${srcdir}/opt/vagrant/embedded/rgloader"
  mkdir -p "${srcdir}/opt/vagrant/bin"
}

build() {
  INSTALLERS_DIR="${srcdir}/vagrant-installers-master"
  VAGRANT_DIR="${srcdir}/vagrant-${_pkg_ver}"
  INSTALL_DIR="${srcdir}/opt/vagrant"
  EMBEDDED_DIR="${INSTALL_DIR}/embedded"

  # Build the Vagrant gem
  pushd "${VAGRANT_DIR}"
  gem build vagrant.gemspec
  mv vagrant-*.gem "${srcdir}/vagrant.gem"
  popd

  # Install the required substrate items
  cp "${INSTALLERS_DIR}/substrate/modules/vagrant_substrate/templates/gemrc.erb" "${EMBEDDED_DIR}/etc/gemrc"
  cp "${INSTALLERS_DIR}/substrate/modules/rubyencoder/files/rgloader/"* "${EMBEDDED_DIR}/rgloader/"

  # Install vagrant launcher
  pushd "${INSTALLERS_DIR}/substrate/modules/vagrant_substrate/files/launcher"
  go get github.com/mitchellh/osext
  go build -o "${INSTALL_DIR}/bin/vagrant"
  popd

  # Install Vagrant and the share plugin
  pushd "${srcdir}"
  export GEM_PATH="${EMBEDDED_DIR}/gems"
  export GEM_HOME="${GEM_PATH}"
  export GEMRC="${EMBEDDED_DIR}/etc/gemrc"

  gem install ./vagrant.gem --no-document
  gem install vagrant-share --force --no-document --conservative --clear-sources --source "https://gems.hashicorp.com"
  cat <<EOF >${EMBEDDED_DIR}/plugins.json
{
    "version": "1",
    "installed": {
        "vagrant-share": {
            "ruby_version": "0",
            "vagrant_version": "${VERSION}"
        }
    }
}
EOF
  chmod 0644 ${EMBEDDED_DIR}/plugins.json
  popd

}

package() {
  mkdir -p "${pkgdir}/opt"
  mv "${srcdir}/opt/vagrant" "${pkgdir}/opt/"
  mkdir -p "${pkgdir}/usr/bin"
  ln -s /opt/vagrant/bin/vagrant "${pkgdir}/usr/bin/vagrant"
}
